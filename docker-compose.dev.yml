services:
  # n8n automation server
  n8n:
    image: n8nio/n8n:1.122.5
    ports: ["5679:5678"]  # Dev uses 5679 to avoid conflict with prod
    env_file:
      - ./n8n/config/n8n.env
    environment:
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_LOG_LEVEL=debug
    volumes:
      - n8n_data:/home/node/.n8n
      - ./backend/data:/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5678/healthz',res=>{if(res.statusCode<500)process.exit(0);process.exit(1)})"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks: [fgt-net]

  # FastAPI backend (proxy to n8n)
  backend:
    build:
      context: ./backend
    ports: ["8001:8000"]  # Dev uses 8001 to avoid conflict with prod
    env_file: [.env]
    environment:
      - PYTHONPATH=/app:/app/shared
      - N8N_INTERNAL_URL=http://n8n:5678
    volumes:
      - ./backend:/app
      - ./shared:/app/shared
    working_dir: /app
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    restart: unless-stopped
    depends_on:
      - n8n
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks: [fgt-net]

  # Dash + FastAPI (admin UI)
  fgt_dashboard:
    # Build from repo root so Dockerfile can COPY fgt_dashboard/ and shared/
    build:
      context: .
      dockerfile: fgt_dashboard/Dockerfile
    ports: ["8051:8050"]  # Dev uses 8051 to avoid conflict with prod
    env_file: [.env]
    environment:
      - PYTHONPATH=/app:/app/shared
    volumes:
      # Hot-reload for dev
      - ./fgt_dashboard:/app
      - ./shared:/app/shared
    working_dir: /app
    # Run FastAPI that mounts Dash at /admin (see api.py)
    command: uvicorn api:app --host 0.0.0.0 --port 8050 --reload
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8050/health')"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks: [fgt-net]

  nginx:
    image: nginx:latest
    ports: ["8088:80"]  # Dev uses 8088 to avoid conflict with prod (80/443)
    volumes:
      - ./nginx.dev.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend
      - fgt_dashboard
      - n8n
    restart: unless-stopped
    networks: [fgt-net]

  certbot:
    image: certbot/certbot
    entrypoint: ""
    command: tail -f /dev/null
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt
    restart: unless-stopped
    networks: [fgt-net]

volumes:
  n8n_data:
    external: true
    name: fgt-checkin-system_n8n_data

networks:
  fgt-net:
