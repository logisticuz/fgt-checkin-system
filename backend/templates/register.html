<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register - FGC Trollhattan</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #000;
      color: #e0e0e0;
      font-family: 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }
    .container {
      max-width: 420px;
      width: 100%;
    }
    header {
      text-align: center;
      padding: 1.5rem 0;
    }
    header h1 {
      color: #58aaff;
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 2px;
      margin-bottom: 0.5rem;
    }
    header p {
      color: #666;
      font-size: 0.9rem;
    }
    .status-summary {
      background: rgba(88, 170, 255, 0.05);
      border: 1px solid rgba(88, 170, 255, 0.2);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .status-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0;
    }
    .status-icon { font-size: 1.2rem; }
    .status-ok { color: #4caf50; }
    .status-missing { color: #ff9800; }

    /* Sections */
    .section {
      background: rgba(88, 170, 255, 0.05);
      border: 1px solid rgba(88, 170, 255, 0.2);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    .section h2 {
      color: #58aaff;
      font-size: 1.1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .section.hidden { display: none; }
    .hidden { display: none; }

    /* Form elements */
    label {
      display: block;
      font-size: 0.85rem;
      color: #58aaff;
      margin-bottom: 0.4rem;
      font-weight: 500;
    }
    input, select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid rgba(88, 170, 255, 0.3);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      font-size: 1rem;
      margin-bottom: 0.75rem;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #58aaff;
      box-shadow: 0 0 0 3px rgba(88, 170, 255, 0.15);
    }
    input::placeholder {
      color: #666;
    }
    /* Checkbox game selection */
    .game-checkboxes {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .game-checkbox {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(88, 170, 255, 0.3);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .game-checkbox:hover {
      border-color: #58aaff;
      background: rgba(88, 170, 255, 0.1);
    }
    .game-checkbox.selected {
      border-color: #4caf50;
      background: rgba(76, 175, 80, 0.15);
    }
    .game-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #58aaff;
      cursor: pointer;
    }
    .game-checkbox label {
      margin: 0;
      cursor: pointer;
      color: #fff;
      font-size: 1rem;
    }

    /* Buttons */
    .btn {
      display: block;
      width: 100%;
      padding: 0.9rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
    }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary {
      background: #58aaff;
      color: #000;
    }
    .btn-success {
      background: #4caf50;
      color: #fff;
    }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #58aaff;
      border: 1px solid #58aaff;
    }

    /* Payment info note */
    .swish-note {
      background: rgba(255, 152, 0, 0.1);
      border: 1px solid rgba(255, 152, 0, 0.3);
      border-radius: 8px;
      padding: 0.75rem;
      font-size: 0.85rem;
      color: #ff9800;
    }
    .swish-note strong {
      color: #ffb74d;
    }

    /* Messages */
    .message {
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    .message.success {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid #4caf50;
      color: #4caf50;
    }
    .message.error {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid #f44336;
      color: #f44336;
    }
    .message.info {
      background: rgba(88, 170, 255, 0.2);
      border: 1px solid #58aaff;
      color: #58aaff;
    }

    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 0.5rem;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 1.5rem 0;
      color: #444;
      font-size: 0.75rem;
    }
    footer a { color: #58aaff; text-decoration: none; }
    footer .logo {
      max-width: 320px;
      width: 100%;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>REGISTRATION</h1>
      <p>Complete your registration</p>
    </header>

    <!-- Status Summary -->
    <div class="status-summary">
      <div class="status-item" id="status-startgg">
        <span class="status-icon">-</span>
        <span>Start.gg</span>
      </div>
      <div class="status-item" id="status-member">
        <span class="status-icon">-</span>
        <span>Sverok Member</span>
      </div>
      <div class="status-item" id="status-payment">
        <span class="status-icon">-</span>
        <span>Payment</span>
      </div>
    </div>

    <!-- Messages container -->
    <div id="messages"></div>

    <!-- Section: eBas Membership -->
    <section id="section-ebas" class="section hidden">
      <h2>Become a Sverok Member</h2>
      <p style="margin-bottom: 1rem; color: #aaa;">
        Membership is free and only takes a few seconds. We use SPAR to fetch your details automatically.
      </p>

      <label for="pnr-ebas">Personal ID (YYYYMMDDXXXX)</label>
      <input type="text" id="pnr-ebas" placeholder="199001011234" pattern="\d{10,12}" oninput="validateEbasForm()">

      <label for="email-ebas">Email (optional)</label>
      <input type="email" id="email-ebas" placeholder="your@email.com" oninput="validateEbasForm()">

      <label for="phone-ebas">Phone</label>
      <input type="tel" id="phone-ebas" placeholder="0701234567" required oninput="validateEbasForm()">

      <button type="button" id="btn-register-ebas" class="btn btn-primary" disabled>
        Register as Member
      </button>
    </section>

    <!-- Section: Payment (info only - actual payment on status page) -->
    <section id="section-payment" class="section hidden">
      <h2>ðŸ’³ Payment Required</h2>
      <div class="swish-note" style="margin: 0;">
        <strong id="price-per-game-text">{{ swish_expected_per_game | default(25) }} kr per game.</strong><br>
        Payment details will be shown after you complete registration.
      </div>
    </section>

    <!-- Section: Start.gg Games -->
    <section id="section-startgg" class="section hidden">
      <h2>Select Games</h2>
      <p style="margin-bottom: 1rem; color: #aaa;">
        You are not registered on Start.gg for this event. Select which games you want to enter:
      </p>

      <div id="games" class="game-checkboxes">
        {% if games %}
          {% for game in games %}
        <div class="game-checkbox" onclick="this.classList.toggle('selected'); this.querySelector('input').checked = !this.querySelector('input').checked;">
          <input type="checkbox" id="game-{{ game.id }}" value="{{ game.id }}" data-name="{{ game.name }}">
          <label for="game-{{ game.id }}">{{ game.name }}</label>
        </div>
          {% endfor %}
        {% else %}
        <p style="color: #aaa;">No games available - contact TO</p>
        {% endif %}
      </div>

      <button type="button" id="btn-confirm-games" class="btn btn-primary" {% if not games %}disabled{% endif %}>
        Confirm Selection
      </button>
    </section>

    <!-- Final Submit -->
    <section id="section-final" class="section hidden">
      <button type="button" id="btn-final-checkin" class="btn btn-primary">
        Continue â†’
      </button>
    </section>

    <footer>
      <img src="/static/logo.png" alt="FGC Trollhattan" class="logo">
      <p>Problems? Talk to a tournament organizer.</p>
      <p><a href="/">Back to start</a></p>
    </footer>
  </div>

  <script src="/static/js/validation.js"></script>
  <script>
    // Config
    const WEBHOOK_TOKEN = "{{ n8n_token | default('') }}";
    const tokenParam = WEBHOOK_TOKEN ? `?token=${encodeURIComponent(WEBHOOK_TOKEN)}` : "";

    // Configurable requirements from event settings
    // If a requirement is disabled, we never show that section
    const REQUIRE_PAYMENT = {{ require_payment | default(true) | tojson }};
    const REQUIRE_MEMBERSHIP = {{ require_membership | default(true) | tojson }};
    const REQUIRE_STARTGG = {{ require_startgg | default(true) | tojson }};

    // State from URL params
    // Override "needs" flags based on what's REQUIRED for this event
    const params = new URLSearchParams(window.location.search);
    const state = {
      // Only show eBas section if membership is REQUIRED AND player needs it
      needsEbas: REQUIRE_MEMBERSHIP && params.get("ebas") === "true",
      // Only show payment section if payment is REQUIRED AND player needs it
      needsPayment: REQUIRE_PAYMENT && params.get("payment") === "true",
      // Only show Start.gg section if Start.gg is REQUIRED AND player is not registered
      needsStartgg: REQUIRE_STARTGG && params.get("startgg") === "false",
      name: params.get("name") || localStorage.getItem("namn") || "",
      personnummer: localStorage.getItem("personnummer") || "",
      phone: localStorage.getItem("telefon") || "",
      tag: localStorage.getItem("tag") || "",
      gamesCount: parseInt(params.get("games") || "1", 10),
      eventSlug: params.get("event") || localStorage.getItem("eventSlug") || ""
    };

    // UI helpers
    function showMessage(text, type = "info") {
      const container = document.getElementById("messages");
      container.innerHTML = `<div class="message ${type}">${text}</div>`;
    }

    function clearMessages() {
      document.getElementById("messages").innerHTML = "";
    }

    function setStatus(id, ok) {
      const el = document.getElementById(id);
      const icon = el.querySelector(".status-icon");
      if (ok) {
        icon.textContent = "âœ“";
        icon.classList.add("status-ok");
        icon.classList.remove("status-missing");
      } else {
        icon.textContent = "âœ—";
        icon.classList.add("status-missing");
        icon.classList.remove("status-ok");
      }
    }

    function setButtonLoading(btn, loading) {
      if (loading) {
        btn.disabled = true;
        btn.dataset.originalText = btn.textContent;
        btn.innerHTML = '<span class="spinner"></span>Loading...';
      } else {
        btn.disabled = false;
        btn.textContent = btn.dataset.originalText || btn.textContent;
      }
    }

    // Fetch real status from API and update UI
    async function fetchAndUpdateStatus() {
      if (!state.name) return;

      try {
        const response = await fetch(`/api/participant/${encodeURIComponent(state.name)}/status`);
        if (!response.ok) return;

        const data = await response.json();

        // Update status icons based on real Airtable data
        if (REQUIRE_STARTGG) {
          setStatus("status-startgg", data.startgg === true);
        }
        if (REQUIRE_MEMBERSHIP) {
          setStatus("status-member", data.member === true);
        }
        if (REQUIRE_PAYMENT) {
          setStatus("status-payment", data.payment === true);
          // Show payment section if payment is required but not done
          if (!data.payment) {
            state.needsPayment = true;
            document.getElementById("section-payment").classList.remove("hidden");
          }
        }
      } catch (err) {
        console.warn("Could not fetch status from API:", err);
      }
    }

    // Initialize UI based on state
    function initUI() {
      // Hide status items that are not required for this event
      if (!REQUIRE_STARTGG) {
        document.getElementById("status-startgg").style.display = "none";
      }
      if (!REQUIRE_MEMBERSHIP) {
        document.getElementById("status-member").style.display = "none";
      }
      if (!REQUIRE_PAYMENT) {
        document.getElementById("status-payment").style.display = "none";
      }

      // Set initial status icons (only for required items) - from URL params
      if (REQUIRE_STARTGG) setStatus("status-startgg", !state.needsStartgg);
      if (REQUIRE_MEMBERSHIP) setStatus("status-member", !state.needsEbas);
      if (REQUIRE_PAYMENT) setStatus("status-payment", !state.needsPayment);

      // Show relevant sections
      if (state.needsEbas) {
        document.getElementById("section-ebas").classList.remove("hidden");
        // Pre-fill from localStorage
        if (state.personnummer) document.getElementById("pnr-ebas").value = state.personnummer;
      }

      if (state.needsPayment) {
        document.getElementById("section-payment").classList.remove("hidden");
        // Payment details (QR, amount) shown on status page after registration
      }

      if (state.needsStartgg) {
        document.getElementById("section-startgg").classList.remove("hidden");
      }

      // Show final button if nothing is needed
      updateFinalButton();

      // Fetch real status from API to correct any mismatches
      fetchAndUpdateStatus();
    }

    function updateFinalButton() {
      // Show final button when user-actionable items are done
      // Payment is handled by TO, so we only check eBas and Start.gg
      const userTasksDone = !state.needsEbas && !state.needsStartgg;
      if (userTasksDone) {
        document.getElementById("section-final").classList.remove("hidden");
      }
    }

    // eBas form validation - enables button only when all required fields are valid
    function validateEbasForm() {
      const btn = document.getElementById("btn-register-ebas");
      const pnrRaw = document.getElementById("pnr-ebas").value.trim();
      const phone = document.getElementById("phone-ebas").value.trim();

      // Validate personnummer (10 or 12 digits)
      const pnr = Validation.sanitizePersonnummer(pnrRaw);
      const pnrValid = pnr && (pnr.length === 10 || pnr.length === 12);

      // Validate phone (minimum 7 digits)
      const cleanedPhone = Validation.sanitizePhone(phone);
      const phoneValid = cleanedPhone.length >= 7;

      // Enable button only if both are valid
      btn.disabled = !(pnrValid && phoneValid);
    }

    // eBas Registration
    document.getElementById("btn-register-ebas").addEventListener("click", async function() {
      const btn = this;
      const pnrRaw = document.getElementById("pnr-ebas").value.trim();
      const email = document.getElementById("email-ebas").value.trim();
      const phone = document.getElementById("phone-ebas").value.trim();

      // Sanitize and validate personnummer using validation.js
      const pnr = Validation.sanitizePersonnummer(pnrRaw);

      if (!pnr) {
        showMessage("Personal ID is required", "error");
        return;
      }

      if (pnr.length !== 10 && pnr.length !== 12) {
        showMessage(`Personal ID must be 10 or 12 digits (you entered ${pnr.length} digits)`, "error");
        return;
      }

      // Validate email if provided
      if (email && !email.includes("@")) {
        showMessage("Please enter a valid email address", "error");
        return;
      }

      // Validate phone if provided (minimum 7 digits)
      if (phone) {
        const cleanedPhone = Validation.sanitizePhone(phone);
        if (cleanedPhone.length > 0 && cleanedPhone.length < 7) {
          showMessage("Phone number too short (minimum 7 digits)", "error");
          return;
        }
      }

      setButtonLoading(btn, true);
      clearMessages();

      try {
        // Include tag and slug so n8n can update the Airtable record
        const tag = state.tag || localStorage.getItem("tag") || "";
        const slug = state.eventSlug || localStorage.getItem("eventSlug") || "";

        const response = await fetch(`/n8n/webhook/ebas/register${tokenParam}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ personnummer: pnr, email, telephone: phone, tag, slug })
        });

        const data = await response.json();

        if (data.success || data.already_member) {
          // eBas registration successful - now update Airtable via backend
          // This separates concerns: n8n handles Sverok API, backend handles Airtable
          try {
            const memberResponse = await fetch("/api/player/member", {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                tag: tag,
                slug: slug,
                member: true
              })
            });

            if (!memberResponse.ok) {
              console.warn("Could not update member status in Airtable:", await memberResponse.text());
              // Don't fail the whole flow - eBas registration was successful
            }
          } catch (memberErr) {
            console.warn("Error updating member status:", memberErr);
            // Don't fail - eBas registration was successful
          }

          showMessage(data.already_member
            ? "You are already a member - perfect!"
            : "Membership registered!", "success");
          state.needsEbas = false;
          setStatus("status-member", true);
          document.getElementById("section-ebas").classList.add("hidden");
          updateFinalButton();
        } else {
          // Handle different response formats from n8n
          let errorMsg = "Could not register membership";
          if (typeof data.message === "string") {
            errorMsg = data.message;
          } else if (data.message?.error) {
            errorMsg = data.message.error;
          } else if (data.error && typeof data.error === "string") {
            errorMsg = data.error;
          }
          showMessage(errorMsg, "error");
        }
      } catch (err) {
        console.error("eBas error:", err);
        showMessage("Something went wrong. Please try again.", "error");
      } finally {
        setButtonLoading(btn, false);
      }
    });

    // Payment section is informational only - TO verifies manually

    // Game selection
    document.getElementById("btn-confirm-games").addEventListener("click", async function() {
      const btn = this;
      // Get selected checkboxes
      const checkboxes = document.querySelectorAll('#games input[type="checkbox"]:checked');
      const selectedNames = Array.from(checkboxes).map(cb => cb.dataset.name);

      if (selectedNames.length === 0) {
        showMessage("Please select at least one game", "error");
        return;
      }

      setButtonLoading(btn, true);
      clearMessages();

      // Get slug from settings or localStorage
      const slug = state.eventSlug || localStorage.getItem("eventSlug") || "";
      const tag = state.tag || localStorage.getItem("tag") || "";

      if (!slug || !tag) {
        showMessage("Missing event or player info. Please go back and check in again.", "error");
        setButtonLoading(btn, false);
        return;
      }

      try {
        // POST selected games to backend
        const response = await fetch("/api/player/games", {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            tag: tag,
            slug: slug,
            games: selectedNames
          })
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.detail || "Failed to save games");
        }

        // Store selection locally too
        localStorage.setItem("selectedGames", JSON.stringify(selectedNames));
        state.gamesCount = selectedNames.length;
        state.needsStartgg = false;

        showMessage(`${selectedNames.length} game(s) saved: ${selectedNames.join(", ")}`, "success");
        setStatus("status-startgg", true);
        document.getElementById("section-startgg").classList.add("hidden");
        updateFinalButton();
      } catch (err) {
        console.error("Game selection error:", err);
        showMessage(err.message || "Failed to save games. Please try again.", "error");
      } finally {
        setButtonLoading(btn, false);
      }
    });

    // Final check-in
    document.getElementById("btn-final-checkin").addEventListener("click", async function() {
      const btn = this;
      setButtonLoading(btn, true);

      try {
        // Redirect to status page
        const name = state.name || localStorage.getItem("namn");
        window.location.href = `/status/${encodeURIComponent(name)}`;
      } catch (err) {
        console.error("Final checkin error:", err);
        showMessage("Something went wrong. Please try again.", "error");
        setButtonLoading(btn, false);
      }
    });

    // Initialize on load
    initUI();
  </script>
</body>
</html>
