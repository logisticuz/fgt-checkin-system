<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register - FGC Trollhattan</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #000;
      color: #e0e0e0;
      font-family: 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }
    .container {
      max-width: 420px;
      width: 100%;
    }
    header {
      text-align: center;
      padding: 1.5rem 0;
    }
    header h1 {
      color: #58aaff;
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 2px;
      margin-bottom: 0.5rem;
    }
    header p {
      color: #666;
      font-size: 0.9rem;
    }
    .status-summary {
      background: rgba(88, 170, 255, 0.05);
      border: 1px solid rgba(88, 170, 255, 0.2);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .status-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0;
    }
    .status-icon { font-size: 1.2rem; }
    .status-ok { color: #4caf50; }
    .status-missing { color: #ff9800; }

    /* Sections */
    .section {
      background: rgba(88, 170, 255, 0.05);
      border: 1px solid rgba(88, 170, 255, 0.2);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    .section h2 {
      color: #58aaff;
      font-size: 1.1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .section.hidden { display: none; }
    .hidden { display: none; }

    /* Form elements */
    label {
      display: block;
      font-size: 0.85rem;
      color: #58aaff;
      margin-bottom: 0.4rem;
      font-weight: 500;
    }
    input, select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid rgba(88, 170, 255, 0.3);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      font-size: 1rem;
      margin-bottom: 0.75rem;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #58aaff;
      box-shadow: 0 0 0 3px rgba(88, 170, 255, 0.15);
    }
    input::placeholder {
      color: #666;
    }
    /* Checkbox game selection */
    .game-checkboxes {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .game-checkbox {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(88, 170, 255, 0.3);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .game-checkbox:hover {
      border-color: #58aaff;
      background: rgba(88, 170, 255, 0.1);
    }
    .game-checkbox.selected {
      border-color: #4caf50;
      background: rgba(76, 175, 80, 0.15);
    }
    .game-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #58aaff;
      cursor: pointer;
    }
    .game-checkbox label {
      margin: 0;
      cursor: pointer;
      color: #fff;
      font-size: 1rem;
    }

    /* Buttons */
    .btn {
      display: block;
      width: 100%;
      padding: 0.9rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
    }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary {
      background: #58aaff;
      color: #000;
    }
    .btn-success {
      background: #4caf50;
      color: #fff;
    }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #58aaff;
      border: 1px solid #58aaff;
    }

    /* Payment / Swish */
    .swish-container {
      text-align: center;
    }
    .swish-box {
      background: linear-gradient(135deg, #1a2a1a 0%, #0d1f0d 100%);
      border: 1px solid rgba(18, 168, 87, 0.3);
      border-radius: 16px;
      padding: 1.5rem;
      margin: 1rem 0;
    }
    .swish-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .swish-logo {
      width: 80px;
      height: auto;
    }
    .swish-amount {
      font-size: 2rem;
      font-weight: bold;
      color: #12a857;
      margin: 0.5rem 0 1rem;
    }
    .swish-amount span {
      font-size: 1rem;
      color: #888;
      font-weight: normal;
    }
    .swish-qr {
      background: #fff;
      padding: 12px;
      border-radius: 12px;
      display: inline-block;
      margin: 0.5rem 0;
    }
    .swish-qr img {
      width: 160px;
      height: 160px;
      display: block;
    }
    .swish-number-box {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      margin: 1rem 0;
      display: inline-block;
    }
    .swish-number-label {
      font-size: 0.75rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 0.25rem;
    }
    .swish-number {
      font-size: 1.4rem;
      font-weight: bold;
      color: #fff;
      font-family: 'Courier New', monospace;
      letter-spacing: 1px;
    }
    .swish-divider {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin: 1rem 0;
      color: #666;
      font-size: 0.85rem;
    }
    .swish-divider::before,
    .swish-divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background: rgba(255, 255, 255, 0.1);
    }
    .swish-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: #12a857;
      color: #fff;
      padding: 1rem 2rem;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.2s;
      margin: 0.5rem 0;
    }
    .swish-btn:hover {
      background: #0e8a47;
      transform: scale(1.02);
    }
    .swish-btn:active {
      transform: scale(0.98);
    }
    .swish-note {
      background: rgba(255, 152, 0, 0.1);
      border: 1px solid rgba(255, 152, 0, 0.3);
      border-radius: 8px;
      padding: 0.75rem;
      margin-top: 1rem;
      font-size: 0.85rem;
      color: #ff9800;
    }
    .swish-note strong {
      color: #ffb74d;
    }

    /* Messages */
    .message {
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    .message.success {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid #4caf50;
      color: #4caf50;
    }
    .message.error {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid #f44336;
      color: #f44336;
    }
    .message.info {
      background: rgba(88, 170, 255, 0.2);
      border: 1px solid #58aaff;
      color: #58aaff;
    }

    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 0.5rem;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 1.5rem 0;
      color: #444;
      font-size: 0.75rem;
    }
    footer a { color: #58aaff; text-decoration: none; }
    footer .logo {
      max-width: 320px;
      width: 100%;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>REGISTRATION</h1>
      <p>Complete your registration</p>
    </header>

    <!-- Status Summary -->
    <div class="status-summary">
      <div class="status-item" id="status-startgg">
        <span class="status-icon">-</span>
        <span>Start.gg</span>
      </div>
      <div class="status-item" id="status-member">
        <span class="status-icon">-</span>
        <span>Sverok Member</span>
      </div>
      <div class="status-item" id="status-payment">
        <span class="status-icon">-</span>
        <span>Payment</span>
      </div>
    </div>

    <!-- Messages container -->
    <div id="messages"></div>

    <!-- Section: eBas Membership -->
    <section id="section-ebas" class="section hidden">
      <h2>Become a Sverok Member</h2>
      <p style="margin-bottom: 1rem; color: #aaa;">
        Membership is free and only takes a few seconds. We use SPAR to fetch your details automatically.
      </p>

      <label for="pnr-ebas">Personal ID (YYYYMMDDXXXX)</label>
      <input type="text" id="pnr-ebas" placeholder="199001011234" pattern="\d{10,12}">

      <label for="email-ebas">Email</label>
      <input type="email" id="email-ebas" placeholder="your@email.com">

      <label for="phone-ebas">Phone (optional)</label>
      <input type="tel" id="phone-ebas" placeholder="0701234567">

      <button type="button" id="btn-register-ebas" class="btn btn-primary">
        Register as Member
      </button>
    </section>

    <!-- Section: Payment -->
    <section id="section-payment" class="section hidden">
      <h2>Payment</h2>
      <div class="swish-container">
        <div class="swish-box">
          <!-- Amount display -->
          <div class="swish-amount" id="swish-amount">
            <span>Amount to pay</span><br>
            0 kr
          </div>

          <!-- Desktop: Show QR code -->
          <div id="swish-desktop" class="hidden">
            <div class="swish-qr">
              <img src="/static/swish-QR.png" alt="Swish QR" id="swish-qr-img">
            </div>
            <p style="color: #aaa; font-size: 0.85rem; margin-top: 0.5rem;">
              Scan with Swish app
            </p>

            <div class="swish-divider">or enter manually</div>

            <div class="swish-number-box">
              <div class="swish-number-label">Swish number</div>
              <div class="swish-number">123-043 78 22</div>
            </div>
          </div>

          <!-- Mobile: Show deep link button -->
          <div id="swish-mobile" class="hidden">
            <a id="swish-deeplink" class="swish-btn">
              Open Swish
            </a>

            <div class="swish-divider">or enter manually</div>

            <div class="swish-number-box">
              <div class="swish-number-label">Swish number</div>
              <div class="swish-number">123-043 78 22</div>
            </div>
          </div>

          <!-- Important note -->
          <div class="swish-note">
            <strong>25 kr per game.</strong><br>
            Write your <strong>tag</strong> and <strong>which games</strong> you're entering in the Swish message!
          </div>
        </div>
      </div>
    </section>

    <!-- Section: Start.gg Games -->
    <section id="section-startgg" class="section hidden">
      <h2>Select Games</h2>
      <p style="margin-bottom: 1rem; color: #aaa;">
        You are not registered on Start.gg for this event. Select which games you want to enter:
      </p>

      <div id="games" class="game-checkboxes">
        {% if games %}
          {% for game in games %}
        <div class="game-checkbox" onclick="this.classList.toggle('selected'); this.querySelector('input').checked = !this.querySelector('input').checked;">
          <input type="checkbox" id="game-{{ game.id }}" value="{{ game.id }}" data-name="{{ game.name }}">
          <label for="game-{{ game.id }}">{{ game.name }}</label>
        </div>
          {% endfor %}
        {% else %}
        <p style="color: #aaa;">No games available - contact TO</p>
        {% endif %}
      </div>

      <button type="button" id="btn-confirm-games" class="btn btn-primary" {% if not games %}disabled{% endif %}>
        Confirm Selection
      </button>
    </section>

    <!-- Final Submit -->
    <section id="section-final" class="section hidden">
      <button type="button" id="btn-final-checkin" class="btn btn-success">
        Complete Check-in
      </button>
    </section>

    <footer>
      <img src="/static/logo.png" alt="FGC Trollhattan" class="logo">
      <p>Problems? Talk to a tournament organizer.</p>
      <p><a href="/">Back to start</a></p>
    </footer>
  </div>

  <script src="/static/js/validation.js"></script>
  <script>
    // Config
    const WEBHOOK_TOKEN = "{{ n8n_token | default('') }}";
    const tokenParam = WEBHOOK_TOKEN ? `?token=${encodeURIComponent(WEBHOOK_TOKEN)}` : "";
    const SWISH_PRICE_PER_GAME = {{ swish_expected_per_game | default(25) }};
    const SWISH_NUMBER = "1230437822"; // Without formatting for deep link

    // Configurable requirements from event settings
    // If a requirement is disabled, we never show that section
    const REQUIRE_PAYMENT = {{ require_payment | default(true) | tojson }};
    const REQUIRE_MEMBERSHIP = {{ require_membership | default(true) | tojson }};
    const REQUIRE_STARTGG = {{ require_startgg | default(true) | tojson }};

    // Mobile detection
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // Generate Swish deep link
    function generateSwishDeepLink(amount, message) {
      const data = {
        version: 1,
        payee: { value: SWISH_NUMBER },
        amount: { value: amount },
        message: { value: message, editable: false }
      };
      return `swish://payment?data=${encodeURIComponent(JSON.stringify(data))}`;
    }

    // State from URL params
    // Override "needs" flags based on what's REQUIRED for this event
    const params = new URLSearchParams(window.location.search);
    const state = {
      // Only show eBas section if membership is REQUIRED AND player needs it
      needsEbas: REQUIRE_MEMBERSHIP && params.get("ebas") === "true",
      // Only show payment section if payment is REQUIRED AND player needs it
      needsPayment: REQUIRE_PAYMENT && params.get("payment") === "true",
      // Only show Start.gg section if Start.gg is REQUIRED AND player is not registered
      needsStartgg: REQUIRE_STARTGG && params.get("startgg") === "false",
      name: params.get("name") || localStorage.getItem("namn") || "",
      personnummer: localStorage.getItem("personnummer") || "",
      phone: localStorage.getItem("telefon") || "",
      tag: localStorage.getItem("tag") || "",
      gamesCount: parseInt(params.get("games") || "1", 10),
      eventSlug: params.get("event") || localStorage.getItem("eventSlug") || ""
    };

    // UI helpers
    function showMessage(text, type = "info") {
      const container = document.getElementById("messages");
      container.innerHTML = `<div class="message ${type}">${text}</div>`;
    }

    function clearMessages() {
      document.getElementById("messages").innerHTML = "";
    }

    function setStatus(id, ok) {
      const el = document.getElementById(id);
      const icon = el.querySelector(".status-icon");
      if (ok) {
        icon.textContent = "✓";
        icon.classList.add("status-ok");
        icon.classList.remove("status-missing");
      } else {
        icon.textContent = "✗";
        icon.classList.add("status-missing");
        icon.classList.remove("status-ok");
      }
    }

    function setButtonLoading(btn, loading) {
      if (loading) {
        btn.disabled = true;
        btn.dataset.originalText = btn.textContent;
        btn.innerHTML = '<span class="spinner"></span>Loading...';
      } else {
        btn.disabled = false;
        btn.textContent = btn.dataset.originalText || btn.textContent;
      }
    }

    // Initialize UI based on state
    function initUI() {
      // Hide status items that are not required for this event
      if (!REQUIRE_STARTGG) {
        document.getElementById("status-startgg").style.display = "none";
      }
      if (!REQUIRE_MEMBERSHIP) {
        document.getElementById("status-member").style.display = "none";
      }
      if (!REQUIRE_PAYMENT) {
        document.getElementById("status-payment").style.display = "none";
      }

      // Set initial status icons (only for required items)
      if (REQUIRE_STARTGG) setStatus("status-startgg", !state.needsStartgg);
      if (REQUIRE_MEMBERSHIP) setStatus("status-member", !state.needsEbas);
      if (REQUIRE_PAYMENT) setStatus("status-payment", !state.needsPayment);

      // Show relevant sections
      if (state.needsEbas) {
        document.getElementById("section-ebas").classList.remove("hidden");
        // Pre-fill from localStorage
        if (state.personnummer) document.getElementById("pnr-ebas").value = state.personnummer;
      }

      if (state.needsPayment) {
        document.getElementById("section-payment").classList.remove("hidden");
        const amount = state.gamesCount * SWISH_PRICE_PER_GAME;
        document.getElementById("swish-amount").innerHTML = `<span>Amount to pay</span><br>${amount} kr`;

        // Show mobile or desktop Swish UI
        if (isMobile()) {
          document.getElementById("swish-mobile").classList.remove("hidden");
          // Generate deep link with player tag/name as message
          const message = state.tag || state.name || "FGC";
          const deepLink = generateSwishDeepLink(amount, message);
          document.getElementById("swish-deeplink").href = deepLink;
        } else {
          document.getElementById("swish-desktop").classList.remove("hidden");
        }
      }

      if (state.needsStartgg) {
        document.getElementById("section-startgg").classList.remove("hidden");
      }

      // Show final button if nothing is needed
      updateFinalButton();
    }

    function updateFinalButton() {
      // Show final button when user-actionable items are done
      // Payment is handled by TO, so we only check eBas and Start.gg
      const userTasksDone = !state.needsEbas && !state.needsStartgg;
      if (userTasksDone) {
        document.getElementById("section-final").classList.remove("hidden");
      }
    }

    // eBas Registration
    document.getElementById("btn-register-ebas").addEventListener("click", async function() {
      const btn = this;
      const pnr = document.getElementById("pnr-ebas").value.trim();
      const email = document.getElementById("email-ebas").value.trim();
      const phone = document.getElementById("phone-ebas").value.trim();

      if (!pnr || pnr.length < 10) {
        showMessage("Please enter a valid personal ID", "error");
        return;
      }

      setButtonLoading(btn, true);
      clearMessages();

      try {
        const response = await fetch(`/n8n/webhook/ebas/register${tokenParam}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ personnummer: pnr, email, telephone: phone })
        });

        const data = await response.json();

        if (data.success || data.already_member) {
          showMessage(data.already_member
            ? "You are already a member - perfect!"
            : "Membership registered!", "success");
          state.needsEbas = false;
          setStatus("status-member", true);
          document.getElementById("section-ebas").classList.add("hidden");
          updateFinalButton();
        } else {
          showMessage(data.message || "Could not register membership", "error");
        }
      } catch (err) {
        console.error("eBas error:", err);
        showMessage("Something went wrong. Please try again.", "error");
      } finally {
        setButtonLoading(btn, false);
      }
    });

    // Payment section is informational only - TO verifies manually

    // Game selection
    document.getElementById("btn-confirm-games").addEventListener("click", async function() {
      const btn = this;
      // Get selected checkboxes
      const checkboxes = document.querySelectorAll('#games input[type="checkbox"]:checked');
      const selectedNames = Array.from(checkboxes).map(cb => cb.dataset.name);

      if (selectedNames.length === 0) {
        showMessage("Please select at least one game", "error");
        return;
      }

      setButtonLoading(btn, true);
      clearMessages();

      // Get slug from settings or localStorage
      const slug = state.eventSlug || localStorage.getItem("eventSlug") || "";
      const tag = state.tag || localStorage.getItem("tag") || "";

      if (!slug || !tag) {
        showMessage("Missing event or player info. Please go back and check in again.", "error");
        setButtonLoading(btn, false);
        return;
      }

      try {
        // POST selected games to backend
        const response = await fetch("/api/player/games", {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            tag: tag,
            slug: slug,
            games: selectedNames
          })
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.detail || "Failed to save games");
        }

        // Store selection locally too
        localStorage.setItem("selectedGames", JSON.stringify(selectedNames));
        state.gamesCount = selectedNames.length;
        state.needsStartgg = false;

        // Update payment amount if payment section is visible
        if (document.getElementById("section-payment").classList.contains("hidden") === false) {
          const amount = state.gamesCount * SWISH_PRICE_PER_GAME;
          document.getElementById("swish-amount").innerHTML = `<span>Amount to pay</span><br>${amount} kr`;

          // Update deep link with new amount
          if (isMobile()) {
            const message = state.tag || state.name || "FGC";
            const deepLink = generateSwishDeepLink(amount, message);
            document.getElementById("swish-deeplink").href = deepLink;
          }
        }

        showMessage(`${selectedNames.length} game(s) saved: ${selectedNames.join(", ")}`, "success");
        setStatus("status-startgg", true);
        document.getElementById("section-startgg").classList.add("hidden");
        updateFinalButton();
      } catch (err) {
        console.error("Game selection error:", err);
        showMessage(err.message || "Failed to save games. Please try again.", "error");
      } finally {
        setButtonLoading(btn, false);
      }
    });

    // Final check-in
    document.getElementById("btn-final-checkin").addEventListener("click", async function() {
      const btn = this;
      setButtonLoading(btn, true);

      try {
        // Redirect to status page
        const name = state.name || localStorage.getItem("namn");
        window.location.href = `/status/${encodeURIComponent(name)}`;
      } catch (err) {
        console.error("Final checkin error:", err);
        showMessage("Something went wrong. Please try again.", "error");
        setButtonLoading(btn, false);
      }
    });

    // Initialize on load
    initUI();
  </script>
</body>
</html>
