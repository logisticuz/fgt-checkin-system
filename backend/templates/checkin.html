<!-- Check-in form for event participation -->
<form id="checkin-form">
  <!-- Full name input (required) -->
  <label for="namn">Name:</label>
  <input type="text" id="namn" name="namn" required>

  <!-- Phone number input -->
  <label for="telefon">Phone number:</label>
  <input type="tel" id="telefon" name="telefon" required>

  <!-- Tag / Alias -->
  <label for="tag">Tag / Alias:</label>
  <input type="text" id="tag" name="tag" required>

  <!-- Social security number -->
  <label for="personnummer">Personal ID (YYYYMMDDXXXX):</label>
  <input type="text" id="personnummer" name="personnummer" required pattern="\d{10,12}">

  <!-- Event dropdown -->
  <label for="events">Select Event(s):</label>
  <select id="events" name="events" multiple required>
    <option>Loading events...</option>
  </select>

  <!-- Consent -->
  <label>
    <input type="checkbox" required>
    I consent to my data being used to validate membership via Sverok’s Ebas and for tournament registration.
  </label>

  <!-- Submit -->
  <button type="submit">Check in</button>
</form>

<script>
  // Fetch event list dynamically
  async function populateEvents() {
    try {
      const res = await fetch("/n8n/webhook/get-events");
      if (!res.ok) throw new Error("Failed to fetch events");
      const json = await res.json();

      const eventSelect = document.getElementById("events");
      eventSelect.innerHTML = "";
      (json || []).forEach(ev => {
        const option = document.createElement("option");
        option.value = ev.id;
        option.textContent = ev.name;
        eventSelect.appendChild(option);
      });
    } catch (err) {
      console.error("Event load error:", err);
      const eventSelect = document.getElementById("events");
      eventSelect.innerHTML = "<option disabled>Failed to load events</option>";
    }
  }

  populateEvents();

  document.getElementById("checkin-form").addEventListener("submit", async function(e) {
    e.preventDefault();

    const namn = document.getElementById("namn").value.trim();
    const telefon = document.getElementById("telefon").value.trim();
    const tag = document.getElementById("tag").value.trim();
    const personnummer = document.getElementById("personnummer").value.trim();
    const eventSelect = document.getElementById("events");
    const eventIds = Array.from(eventSelect.selectedOptions).map(opt => opt.value);

    // Persist to localStorage for pending/register flows
    localStorage.setItem("namn", namn);
    localStorage.setItem("telefon", telefon);
    localStorage.setItem("tag", tag);
    localStorage.setItem("personnummer", personnummer);
    localStorage.setItem("eventIds", JSON.stringify(eventIds));

    try {
      const response = await fetch("/n8n/webhook/validate-multitag", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ namn, telefon, tag, personnummer, eventIds })
      });

      if (!response.ok) {
        throw new Error(`Validate failed with status ${response.status}`);
      }

      const data = await response.json();

      if (data.klar) {
        // ✅ Let the server decide ready/pending via SSR
        window.location.href = `/status/${encodeURIComponent(namn)}`;
      } else {
        const missing = Array.isArray(data.saknas) ? data.saknas : [];
        // Map "saknas" to query flags (case-insensitive)
        const flags = missing.map(s => {
          const t = String(s).toLowerCase();
          if (t.includes("payment") || t.includes("betalning")) return "payment=true";
          if (t.includes("medlemskap")) return "ebas=true";
          if (t.includes("startgg")) return "startgg=false";
          return "";
        }).filter(Boolean).join("&");

        const qs = `namn=${encodeURIComponent(namn)}${flags ? "&" + flags : ""}`;
        window.location.href = `/register.html?${qs}`;
      }
    } catch (err) {
      console.error("Validation error:", err);
      alert("Something went wrong during validation. Please try again.");
    }
  });
</script>

<!--
Notes:
- Redirects: 'klar' -> /status/{namn}; otherwise -> /register.html?flags
- Flags supported: payment=true, ebas=true, startgg=false
- LocalStorage keys used by pending/register: namn, telefon, tag, personnummer, eventIds
-->
